#!/bin/bash

set -euo pipefail

shopt -s failglob

# Set PROFILE_DIR and APP_BIN if not already set
if [ -z "${PROFILE_DIR:-}" ]; then
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    export PROFILE_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd)"
fi

if [ -z "${APP_BIN:-}" ]; then
    export APP_BIN="${PROFILE_DIR}/bin"
fi

echo "Installing/upgrading AI toolkit tools..."
echo "Note: Installation will continue even if individual tools fail"
echo ""

failed_installs=()

# Ollama
echo "==> Installing/upgrading Ollama..."
if "${APP_BIN}/ollama/install"; then
    echo "✓ Ollama completed successfully"
else
    echo "✗ Ollama failed"
    failed_installs+=("ollama")
fi
echo ""

# LM Studio
echo "==> Installing/upgrading LM Studio..."
if "${APP_BIN}/lmstudio/install"; then
    echo "✓ LM Studio completed successfully"
else
    echo "✗ LM Studio failed"
    failed_installs+=("lmstudio")
fi
echo ""

# Hugging Face CLI
echo "==> Installing/upgrading Hugging Face CLI..."
if "${APP_BIN}/huggingface/install"; then
    echo "✓ Hugging Face CLI completed successfully"
else
    echo "✗ Hugging Face CLI failed"
    failed_installs+=("huggingface")
fi
echo ""

# Raycast
echo "==> Installing/upgrading Raycast..."
if "${APP_BIN}/raycast/install"; then
    echo "✓ Raycast completed successfully"
else
    echo "✗ Raycast failed"
    failed_installs+=("raycast")
fi
echo ""

# Claude Code
echo "==> Installing/upgrading Claude Code..."
if "${APP_BIN}/claude/install"; then
    echo "✓ Claude Code completed successfully"
else
    echo "✗ Claude Code failed"
    failed_installs+=("claude")
fi
echo ""

# GitHub Copilot CLI
echo "==> Installing/upgrading GitHub Copilot CLI..."
if "${APP_BIN}/copilot-cli/install"; then
    echo "✓ GitHub Copilot CLI completed successfully"
else
    echo "✗ GitHub Copilot CLI failed"
    failed_installs+=("copilot-cli")
fi
echo ""

# Gemini CLI
echo "==> Installing/upgrading Gemini CLI..."
if "${APP_BIN}/gemini-cli/install"; then
    echo "✓ Gemini CLI completed successfully"
else
    echo "✗ Gemini CLI failed"
    failed_installs+=("gemini-cli")
fi
echo ""

# vLLM
echo "==> Installing/upgrading vLLM..."
if "${APP_BIN}/vllm/install"; then
    echo "✓ vLLM completed successfully"
else
    echo "✗ vLLM failed"
    failed_installs+=("vllm")
fi
echo ""

# OpenVPN
echo "==> Installing/upgrading OpenVPN..."
if "${APP_BIN}/openvpn/install"; then
    echo "✓ OpenVPN completed successfully"
else
    echo "✗ OpenVPN failed"
    failed_installs+=("openvpn")
fi
echo ""

# Summary
echo "========================================="
echo "AI Toolkit Installation Summary"
echo "========================================="
if [ ${#failed_installs[@]} -eq 0 ]; then
    echo "All tools installed/upgraded successfully!"
else
    echo "Failed installations: ${failed_installs[*]}"
    echo "You can retry individual tools with: just <tool-name>"
fi
echo "========================================="
