#!/usr/bin/env bash
set -euo pipefail

echo "Installing Podman..."

OS="$(uname -s)"

case "$OS" in
    Darwin)
        # Mac installation
        if command -v brew &> /dev/null; then
            echo "Installing podman via Homebrew..."
            brew install podman
            
            # Initialize podman machine if not already done
            if ! podman machine list 2>/dev/null | grep -q "Currently running"; then
                echo "Initializing podman machine..."
                podman machine init || true
                podman machine start || true
            fi
        else
            echo "Error: Homebrew is required to install podman on Mac"
            echo "Please install Homebrew first: https://brew.sh"
            exit 1
        fi
        ;;
    Linux)
        # Detect package manager
        if command -v apt-get &> /dev/null; then
            echo "Installing podman via apt..."
            sudo apt-get update
            sudo apt-get install -y podman
        elif command -v dnf &> /dev/null; then
            echo "Installing podman via dnf..."
            sudo dnf install -y podman
        elif command -v yum &> /dev/null; then
            echo "Installing podman via yum..."
            sudo yum install -y podman
        elif command -v pacman &> /dev/null; then
            echo "Installing podman via pacman..."
            sudo pacman -S --noconfirm podman
        else
            echo "Error: No supported package manager found"
            echo "Please install podman manually: https://podman.io/getting-started/installation"
            exit 1
        fi
        ;;
    *)
        echo "Error: Unsupported operating system: $OS"
        exit 1
        ;;
esac

echo "Podman installed successfully!"
podman --version
