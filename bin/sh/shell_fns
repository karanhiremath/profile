#!/bin/bash


function install_messages() {
    local help="""
fname: install_messages()
params:
    - message_type - start/end message
    - app_name - name of the app to include in message"""
    local message_type="$1"
    local app_name="$2"
    local date_string=$(date +"%Y-%m-%d %H:%M:%S | %s")

    local start_message="""---     Install of ${app_name} started @ ${date_string}       ---"""
    local end_message="""---         Install of ${app_name} completed @ ${date_string}   ---"""

    case "$message_type" in
        start)      echo -e $start_message >&2;;
        end)        echo -e $end_message >&2;;
        -h)         echo -e $help >&2;;
        *)          echo -e $help >&2
    esac
}

function cmd_test_or_install() {
    local app_name="${1}"
    echo "Checking status for ${app_name}"
    if command -v "${app_name}" > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

function install_app() {
    app=$1
    echo "Checking status for ${app}"
    if command -v "${app}" > /dev/null 2>&1; then
        location="$(command -v $app)"
        echo "${app} already available at ${location}."
        # Check if update script exists, run it if available
        if [ -f "${PROFILE_DIR}/bin/${app}/update" ]; then
            echo "Running update for ${app}..."
            "${PROFILE_DIR}"/bin/"${app}"/update
        else
            echo "No update script found for ${app}. Skipping update."
        fi
    else
        "${PROFILE_DIR}"/bin/"${app}"/install
    fi
}

function generate_config_vars()
{
    mkdir -p ~/.config
    touch ~/.config/.vars

    grep -rq "export PROFILE_DIR=${PROFILE_DIR}" ~/.config/.vars || echo "export PROFILE_DIR=${PROFILE_DIR}" >> ~/.config/.vars
    unameOut="$(uname -s)"
    case "${unameOut}" in
        Linux*)     machine=Linux;;
        Darwin*)    machine=Mac;;
        CYGWIN*)    machine=Cygwin;;
        MINGW*)     machine=MinGw;;
        *)          machine="UNKNOWN:${unameOut}"
    esac
    export MACHINE=$machine
    grep -rq "export MACHINE=${MACHINE}" ~/.config/.vars || echo "export MACHINE=${MACHINE}" >> ~/.config/.vars

    unamemOut="$(uname -m)"
    case "${unamemOut}" in
        aarch64)    arch=Arm64;;
        *)          arch="UNKNOWN:${unamemOut}"
    esac
    export ARCH=$arch
    grep -rq "export ARCH=${ARCH}" ~/.config/.vars || echo "export ARCH=${ARCH}" >> ~/.config/.vars
}

# Detect current shell and return the appropriate config file
function get_shell_config_file() {
    local shell_name=$(basename "$SHELL")
    
    case "$shell_name" in
        bash)
            if [ -f ~/.bashrc ]; then
                echo ~/.bashrc
            elif [ -f ~/.bash_profile ]; then
                echo ~/.bash_profile
            else
                echo ~/.profile
            fi
            ;;
        zsh)
            if [ -f ~/.zshrc ]; then
                echo ~/.zshrc
            else
                echo ~/.zprofile
            fi
            ;;
        fish)
            echo ~/.config/fish/config.fish
            ;;
        *)
            # Default to .profile for unknown shells
            echo ~/.profile
            ;;
    esac
}

# Safely add or update an environment variable in shell config
function add_env_var_to_shell_config() {
    local var_name="$1"
    local var_value="$2"
    local config_file="${3:-$(get_shell_config_file)}"
    
    if [ ! -f "$config_file" ]; then
        touch "$config_file"
    fi
    
    # Escape single quotes in the value for safe shell usage
    local escaped_value="${var_value//\'/\'\\\'\'}"
    
    # Check if variable already exists
    if grep -q "^export ${var_name}=" "$config_file" 2>/dev/null; then
        # Remove existing variable and add updated one
        if grep -v "^export ${var_name}=" "$config_file" > "${config_file}.tmp" && \
           echo "export ${var_name}='${escaped_value}'" >> "${config_file}.tmp"; then
            mv "${config_file}.tmp" "$config_file"
            echo "Updated ${var_name} in ${config_file}"
        else
            rm -f "${config_file}.tmp"
            echo "ERROR: Failed to update ${var_name} in ${config_file}"
            return 1
        fi
    else
        # Add new variable
        if echo "export ${var_name}='${escaped_value}'" >> "$config_file"; then
            echo "Added ${var_name} to ${config_file}"
        else
            echo "ERROR: Failed to add ${var_name} to ${config_file}"
            return 1
        fi
    fi
}

# Safely add or update environment variable in ~/.config/.vars
function add_env_var_to_config_vars() {
    local var_name="$1"
    local var_value="$2"
    
    mkdir -p ~/.config
    touch ~/.config/.vars
    
    # Escape single quotes in the value for safe shell usage
    local escaped_value="${var_value//\'/\'\\\'\'}"
    
    # Check if variable already exists
    if grep -q "^export ${var_name}=" ~/.config/.vars 2>/dev/null; then
        # Remove existing variable and add updated one
        if grep -v "^export ${var_name}=" ~/.config/.vars > ~/.config/.vars.tmp && \
           echo "export ${var_name}='${escaped_value}'" >> ~/.config/.vars.tmp; then
            mv ~/.config/.vars.tmp ~/.config/.vars
            echo "Updated ${var_name} in ~/.config/.vars"
        else
            rm -f ~/.config/.vars.tmp
            echo "ERROR: Failed to update ${var_name} in ~/.config/.vars"
            return 1
        fi
    else
        # Add new variable
        if echo "export ${var_name}='${escaped_value}'" >> ~/.config/.vars; then
            echo "Added ${var_name} to ~/.config/.vars"
        else
            echo "ERROR: Failed to add ${var_name} to ~/.config/.vars"
            return 1
        fi
    fi
}

# Setup Google Cloud Vertex AI environment variables
function setup_vertex_ai_env() {
    local service_type="$1"  # "claude" or "gemini"
    
    echo ""
    echo "=========================================="
    echo "Vertex AI Configuration Setup"
    echo "=========================================="
    echo ""
    
    # Check if gcloud is installed
    if ! command -v gcloud >/dev/null 2>&1; then
        echo "ERROR: Google Cloud SDK (gcloud) is not installed."
        echo "Please install it first:"
        echo "  macOS: brew install google-cloud-sdk"
        echo "  Linux: curl https://sdk.cloud.google.com | bash"
        echo ""
        return 1
    fi
    
    # Get current gcloud project
    local current_project=$(gcloud config get-value project 2>/dev/null)
    
    echo "Current gcloud project: ${current_project:-<not set>}"
    echo ""
    
    # Prompt for project ID with validation
    while true; do
        read -p "Enter your Google Cloud Project ID [${current_project}]: " project_id
        project_id="${project_id:-$current_project}"
        
        if [ -z "$project_id" ]; then
            echo "ERROR: Project ID is required"
            return 1
        fi
        
        # Validate project ID format (6-30 chars, lowercase letters, digits, hyphens)
        # Must start with letter or digit, contain only lowercase letters/digits/hyphens
        if [[ "$project_id" =~ ^[a-z0-9][-a-z0-9]{4,28}[a-z0-9]$ ]]; then
            break
        else
            echo "ERROR: Invalid project ID format."
            echo "Project IDs must:"
            echo "  - Be 6-30 characters long"
            echo "  - Start with a lowercase letter or digit"
            echo "  - Contain only lowercase letters, digits, and hyphens"
            echo "  - End with a lowercase letter or digit"
            echo ""
            read -p "Try again? (y/n) [y]: " retry
            retry="${retry:-y}"
            if [[ ! "$retry" =~ ^[Yy]$ ]]; then
                echo "Setup cancelled."
                return 1
            fi
        fi
    done
    
    # Prompt for region
    echo ""
    echo "Common regions:"
    echo "  - us-central1 (Iowa)"
    echo "  - us-east4 (Northern Virginia)"
    echo "  - europe-west4 (Netherlands)"
    echo "  - asia-southeast1 (Singapore)"
    read -p "Enter your preferred region [us-central1]: " region
    region="${region:-us-central1}"
    
    # Add environment variables
    echo ""
    echo "Adding environment variables..."
    
    add_env_var_to_config_vars "GOOGLE_CLOUD_PROJECT" "$project_id"
    add_env_var_to_config_vars "GOOGLE_CLOUD_REGION" "$region"
    
    if [ "$service_type" = "claude" ]; then
        add_env_var_to_config_vars "ANTHROPIC_VERTEX_AI" "true"
        add_env_var_to_config_vars "ANTHROPIC_PROJECT_ID" "$project_id"
        add_env_var_to_config_vars "ANTHROPIC_REGION" "$region"
    fi
    
    echo ""
    echo "Environment variables configured in ~/.config/.vars"
    echo ""
    echo "To apply changes immediately, run:"
    echo "  source ~/.config/.vars"
    echo ""
    
    # Prompt to enable APIs
    read -p "Would you like to enable required Vertex AI APIs now? (y/n) [y]: " enable_apis
    enable_apis="${enable_apis:-y}"
    
    if [[ "$enable_apis" =~ ^[Yy]$ ]]; then
        echo ""
        echo "Enabling Vertex AI APIs..."
        if ! gcloud config set project "$project_id"; then
            echo "ERROR: Failed to set project. Please check your permissions."
            return 1
        fi
        if ! gcloud services enable aiplatform.googleapis.com; then
            echo "ERROR: Failed to enable APIs. Please check your permissions and project settings."
            return 1
        fi
        echo "APIs enabled successfully!"
    fi
    
    echo ""
    echo "=========================================="
    echo "Vertex AI setup complete!"
    echo "=========================================="
    echo ""
    
    return 0
}
