#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${APP_BIN}/sh/shell_fns" --source-only
. "${APP_BIN}/sh/brew_helper.sh"

app_name="gh"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

if command -v gh >/dev/null 2>&1; then
    echo "GitHub CLI already installed!"
else
    install_messages "start" "$app_name"

    case "${MACHINE}" in
        Darwin|Mac)
            echo "Installing GitHub CLI on Mac..."
            ensure_brew_in_path || {
                echo "ERROR: Homebrew not found. Please install Homebrew first."
                exit 1
            }
            brew install gh
            ;;
        Linux)
            echo "Installing GitHub CLI on Linux..."
            # Debian/Ubuntu
            if command -v apt-get >/dev/null 2>&1; then
                type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
                curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
                    && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
                    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
                    && sudo apt update \
                    && sudo apt install gh -y
            # RHEL/Fedora/CentOS
            elif command -v dnf >/dev/null 2>&1; then
                sudo dnf install -y 'dnf-command(config-manager)'
                sudo dnf config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
                sudo dnf install -y gh
            elif command -v yum >/dev/null 2>&1; then
                sudo yum install -y yum-utils
                sudo yum-config-manager --add-repo https://cli.github.com/packages/rpm/gh-cli.repo
                sudo yum install -y gh
            else
                echo "Unsupported Linux distribution. Please install manually from https://github.com/cli/cli"
                exit 1
            fi
            ;;
        *)
            echo "Unsupported platform: ${MACHINE}"
            exit 1
            ;;
    esac

    install_messages "end" "$app_name"
fi

# Prompt user to authenticate with GitHub
echo ""
echo "GitHub CLI installed successfully!"
echo "To authenticate with GitHub, please run: gh auth login"
echo ""
read -p "Would you like to authenticate now? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    gh auth login
else
    echo "You can authenticate later by running: gh auth login"
fi
