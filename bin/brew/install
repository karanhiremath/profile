#!/bin/bash

set -euo pipefail

shopt -s failglob

APP_BIN="$(pwd)"

. "${APP_BIN}"/bin/sh/shell_fns --source-only

app_name="brew"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

if command -v brew >/dev/null 2>&1; then
    echo "Homebrew already installed. Updating..."
    brew update
else
    install_messages "start" "$app_name"

    case "${MACHINE}" in
        Darwin|Mac)
            echo "Installing Homebrew on Mac..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            # Add Homebrew to PATH for current session and shell profiles
            # On Apple Silicon, Homebrew is in /opt/homebrew
            # On Intel Macs, Homebrew is in /usr/local
            if [ -d "/opt/homebrew/bin" ]; then
                # Apple Silicon Mac
                export PATH="/opt/homebrew/bin:$PATH"
                eval "$(/opt/homebrew/bin/brew shellenv)"
            elif [ -d "/usr/local/bin" ]; then
                # Intel Mac
                export PATH="/usr/local/bin:$PATH"
                eval "$(/usr/local/bin/brew shellenv)"
            fi
            
            echo "Homebrew installed and added to PATH for current session."
            ;;
        Linux)
            echo "Installing Homebrew on Linux (Linuxbrew)..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            # Add Homebrew to PATH for Linux
            echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.bashrc
            echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> ~/.zshrc
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            ;;
        *)
            echo "Unsupported platform: ${MACHINE}"
            exit 1
            ;;
    esac

    install_messages "end" "$app_name"
fi
