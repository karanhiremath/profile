#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${PROFILE_DIR}"/bin/sh/shell_fns --source-only

app_name="arcanist"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

if command -v arc >/dev/null 2>&1; then
    echo "Arcanist already installed!"
else
    install_messages "start" "$app_name"

    case "${MACHINE}" in
        Darwin|Mac)
            echo "Installing arcanist on Mac..."
            brew install --head arcanist
            ;;
        Linux)
            echo "Installing arcanist on Linux..."
            # Clone arcanist and libphutil
            mkdir -p ~/opt
            cd ~/opt
            if [ ! -d "arcanist" ]; then
                git clone https://github.com/phacility/arcanist.git
            fi
            if [ ! -d "libphutil" ]; then
                git clone https://github.com/phacility/libphutil.git
            fi
            
            # Add to PATH (user should add this to their shell profile)
            echo "Arcanist installed to ~/opt/arcanist"
            echo "Add the following to your shell profile:"
            echo "export PATH=\$PATH:~/opt/arcanist/bin"
            ;;
        *)
            echo "Unsupported platform: ${MACHINE}"
            exit 1
            ;;
    esac

    install_messages "end" "$app_name"
fi
