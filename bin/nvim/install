#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${PROFILE_DIR}/bin/sh/shell_fns" --source-only

touch "${HOME}/.netrc"
mkdir -p "${HOME}/.cache/nvim/undo"
mkdir -p "${HOME}/.config/nvim/"
ln -fns "${PROFILE_DIR}"/bin/nvim/init.lua "${HOME}"/.config/nvim/init.lua
ln -fns "${PROFILE_DIR}"/bin/nvim/lua "${HOME}"/.config/nvim/lua
ln -fns "${PROFILE_DIR}"/bin/nvim/after "${HOME}"/.config/nvim/after

app_name="nvim"
nvim_version_fallback="v0.9.5"  # Fallback for older systems
bob_version="2.8.0"
bob_install_location="$HOME/.local/share/bob/nvim-bin"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

install_messages "start" "$app_name"

# Function to get latest nvim version from GitHub
get_latest_nvim_version() {
    echo "Fetching latest neovim version from GitHub..."
    local latest_version
    
    # Try using gh if available, otherwise use curl
    if command -v gh >/dev/null 2>&1; then
        latest_version=$(gh api repos/neovim/neovim/releases/latest --jq '.tag_name' 2>/dev/null)
    else
        latest_version=$(curl -fsSL https://api.github.com/repos/neovim/neovim/releases/latest 2>/dev/null | grep -o '"tag_name": "[^"]*' | cut -d'"' -f4)
    fi
    
    if [ -n "$latest_version" ]; then
        echo "Latest neovim version: ${latest_version}"
        echo "$latest_version"
    else
        echo "Failed to fetch latest version, will use fallback"
        echo ""
    fi
}

# Function to try installing nvim with bob
try_install_nvim_bob() {
    local version=$1
    echo "Attempting to install neovim ${version} via bob-nvim..."
    
    if ! command -v bob >/dev/null 2>&1; then
        echo "Installing bob-nvim to manage neovim versions..."
        cargo install bob-nvim --locked --version "${bob_version}"
    fi
    
    export PATH=$PATH:~/.cargo/bin/bob:${bob_install_location}
    
    # Try to install the version
    if ~/.cargo/bin/bob use "${version}" 2>/dev/null; then
        echo "Successfully installed neovim ${version}"
        
        # Test if nvim actually runs
        if ${bob_install_location}/nvim --version >/dev/null 2>&1; then
            echo "Neovim ${version} is working correctly"
            return 0
        else
            echo "Neovim ${version} installed but failed to run (likely glibc incompatibility)"
            return 1
        fi
    else
        echo "Failed to install neovim ${version}"
        return 1
    fi
}

case "${MACHINE}" in
    Darwin|Mac)
        echo "Installing nvim on Mac..."
        # Check if cargo is available, if not install via homebrew
        if ! command -v cargo >/dev/null 2>&1; then
            echo "Cargo not found, installing latest nvim via Homebrew..."
            brew install neovim
        else
            # Get latest version from GitHub
            nvim_version_latest=$(get_latest_nvim_version)
            
            if [ -z "$nvim_version_latest" ]; then
                echo "Could not fetch latest version, using fallback ${nvim_version_fallback}..."
                nvim_version_latest="${nvim_version_fallback}"
            fi
            
            # Try latest first, fall back to older version if it fails
            if ! try_install_nvim_bob "${nvim_version_latest}"; then
                echo "Version ${nvim_version_latest} failed, trying fallback version ${nvim_version_fallback}..."
                if try_install_nvim_bob "${nvim_version_fallback}"; then
                    echo "Using neovim ${nvim_version_fallback} - will install compatible nvim-lspconfig"
                    # Mark that we need older lspconfig
                    touch "${PROFILE_DIR}/bin/nvim/.use-old-lspconfig"
                else
                    echo "Bob installation failed, falling back to Homebrew..."
                    brew install neovim
                fi
            fi
        fi
        ;;
    Linux|*)
        echo "Installing nvim on Linux..."
        if ! command -v cargo >/dev/null 2>&1; then
            echo "ERROR: cargo is required but not installed. Please install Rust/Cargo first."
            exit 1
        fi
        
        # Get latest version from GitHub
        nvim_version_latest=$(get_latest_nvim_version)
        
        if [ -z "$nvim_version_latest" ]; then
            echo "Could not fetch latest version, using fallback ${nvim_version_fallback}..."
            nvim_version_latest="${nvim_version_fallback}"
        fi
        
        # Try latest first, fall back to older version if it fails
        if ! try_install_nvim_bob "${nvim_version_latest}"; then
            echo "Version ${nvim_version_latest} failed (possibly due to glibc incompatibility), trying fallback version ${nvim_version_fallback}..."
            if try_install_nvim_bob "${nvim_version_fallback}"; then
                echo "Using neovim ${nvim_version_fallback} - will install compatible nvim-lspconfig"
                # Mark that we need older lspconfig
                touch "${PROFILE_DIR}/bin/nvim/.use-old-lspconfig"
            else
                echo "ERROR: Failed to install neovim via bob"
                exit 1
            fi
        fi
        ;;
esac

# Install nvim plugins after nvim is installed
echo "Installing nvim plugins..."
"${PROFILE_DIR}/bin/nvim/install-plugins"

install_messages "end" "$app_name"
