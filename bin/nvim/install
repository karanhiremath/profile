#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${PROFILE_DIR}/bin/sh/shell_fns" --source-only

touch "${HOME}/.netrc"
mkdir -p "${HOME}/.cache/nvim/undo"
mkdir -p "${HOME}/.config/nvim/"
ln -fns "${PROFILE_DIR}"/bin/nvim/init.lua "${HOME}"/.config/nvim/init.lua
ln -fns "${PROFILE_DIR}"/bin/nvim/lua "${HOME}"/.config/nvim/lua
ln -fns "${PROFILE_DIR}"/bin/nvim/after "${HOME}"/.config/nvim/after

app_name="nvim"
nvim_version="v0.9.5"
bob_version="2.8.0"
bob_install_location="$HOME/.local/share/bob/nvim-bin"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

install_messages "start" "$app_name"

case "${MACHINE}" in
    Darwin|Mac)
        echo "Installing nvim on Mac..."
        # Check if cargo is available, if not install via homebrew
        if ! command -v cargo >/dev/null 2>&1; then
            echo "Cargo not found, installing nvim via Homebrew..."
            brew install neovim
        else
            echo "Installing bob-nvim to manage neovim versions..."
            cargo install bob-nvim --locked --version "${bob_version}"
            export PATH=$PATH:~/.cargo/bin/bob:${bob_install_location}
            ~/.cargo/bin/bob use "${nvim_version}"
        fi
        ;;
    Linux|*)
        echo "Installing bob-nvim to manage neovim versions..."
        if ! command -v cargo >/dev/null 2>&1; then
            echo "ERROR: cargo is required but not installed. Please install Rust/Cargo first."
            exit 1
        fi
        cargo install bob-nvim --locked --version "${bob_version}"
        export PATH=$PATH:~/.cargo/bin/bob:${bob_install_location}
        ~/.cargo/bin/bob use "${nvim_version}"
        ;;
esac

# Install nvim plugins after nvim is installed
echo "Installing nvim plugins..."
"${PROFILE_DIR}/bin/nvim/install-plugins"

install_messages "end" "$app_name"
