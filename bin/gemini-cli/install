#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${APP_BIN}/sh/shell_fns" --source-only
. "${APP_BIN}/sh/brew_helper.sh"

app_name="gemini-cli"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

if command -v gemini >/dev/null 2>&1; then
    echo "Gemini CLI already installed!"
else
    install_messages "start" "$app_name"

    case "${MACHINE}" in
        Darwin|Linux)
            echo "Installing Gemini CLI..."
            # Check if pip3 is available
            if ! command -v pip3 >/dev/null 2>&1; then
                echo "pip3 not found. Installing Python3 and pip..."
                case "${MACHINE}" in
                    Darwin)
                        ensure_brew_in_path || {
                            echo "ERROR: Homebrew not found. Please install Homebrew first."
                            exit 1
                        }
                        brew install python3
                        ;;
                    Linux)
                        if command -v apt-get >/dev/null 2>&1; then
                            sudo apt-get update && sudo apt-get install -y python3-pip
                        elif command -v dnf >/dev/null 2>&1; then
                            sudo dnf install -y python3-pip
                        elif command -v yum >/dev/null 2>&1; then
                            sudo yum install -y python3-pip
                        else
                            echo "ERROR: Could not install pip3. Please install Python3 and pip3 manually."
                            exit 1
                        fi
                        ;;
                esac
            fi
            
            # Install gemini-cli package
            pip3 install --user gemini-cli
            ;;
        *)
            echo "Unsupported platform: ${MACHINE}"
            exit 1
            ;;
    esac

    install_messages "end" "$app_name"
fi

echo ""
echo "Gemini CLI installed successfully!"
echo ""
echo "=========================================="
echo "Setup Options:"
echo "=========================================="
echo ""
echo "OPTION 1: Google AI Studio API (Recommended for development/personal use)"
echo "--------------------------------------------------------------------------"
echo "To use Gemini CLI, you'll need to set up your API key:"
echo "  export GEMINI_API_KEY='your-api-key-here'"
echo "Get your API key from: https://makersuite.google.com/app/apikey"
echo ""
echo "Usage:"
echo "  gemini 'your prompt here'"
echo ""
echo "OPTION 2: Google Cloud Vertex AI (Recommended for production/enterprise)"
echo "-------------------------------------------------------------------------"
echo "Vertex AI provides native access to Gemini models via Google Cloud Platform."
echo ""
echo "Prerequisites:"
echo "  1. Google Cloud account with billing enabled"
echo "  2. A GCP project created"
echo "  3. Google Cloud SDK (gcloud) installed"
echo ""
echo "Setup Steps:"
echo ""
echo "  1. Install Google Cloud SDK if not already installed:"
echo "     - macOS: brew install google-cloud-sdk"
echo "     - Linux: curl https://sdk.cloud.google.com | bash"
echo ""
echo "  2. Initialize and authenticate:"
echo "     gcloud init"
echo "     gcloud auth login"
echo "     gcloud auth application-default login"
echo ""
echo "  3. Set your project:"
echo "     gcloud config set project YOUR_PROJECT_ID"
echo ""
echo "  4. Enable required APIs:"
echo "     gcloud services enable aiplatform.googleapis.com"
echo ""
echo "  5. Grant necessary permissions (if needed):"
echo "     gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \\"
echo "       --member='user:YOUR_EMAIL' \\"
echo "       --role='roles/aiplatform.user'"
echo ""
echo "  6. Set environment variables:"
echo "     export GOOGLE_CLOUD_PROJECT='YOUR_PROJECT_ID'"
echo "     export GOOGLE_CLOUD_REGION='us-central1'  # or your preferred region"
echo ""
echo "  7. Using Vertex AI with Python SDK:"
echo "     Install the Vertex AI SDK:"
echo "     pip3 install --user google-cloud-aiplatform"
echo ""
echo "     Example usage in Python:"
echo "     from google.cloud import aiplatform"
echo "     aiplatform.init(project='YOUR_PROJECT_ID', location='us-central1')"
echo ""
echo "  8. Using gcloud CLI directly with Vertex AI:"
echo "     Example curl command to generate content:"
echo "     curl -X POST \\"
echo "       -H \"Authorization: Bearer \$(gcloud auth print-access-token)\" \\"
echo "       -H \"Content-Type: application/json\" \\"
echo "       https://\${GOOGLE_CLOUD_REGION}-aiplatform.googleapis.com/v1/projects/\${GOOGLE_CLOUD_PROJECT}/locations/\${GOOGLE_CLOUD_REGION}/publishers/google/models/gemini-pro:predict \\"
echo "       -d '{\"instances\": [{\"prompt\": \"Your prompt here\"}]}'"
echo ""
echo "Available Gemini Models on Vertex AI:"
echo "  - gemini-1.0-pro"
echo "  - gemini-1.0-pro-vision"
echo "  - gemini-1.5-pro"
echo "  - gemini-1.5-flash"
echo "  - gemini-2.0-flash-exp (experimental)"
echo ""
echo "Vertex AI Benefits:"
echo "  - Enterprise-grade security and compliance"
echo "  - Integrated with Google Cloud services"
echo "  - Unified billing and management"
echo "  - Higher rate limits and quotas"
echo "  - Data residency and privacy controls"
echo "  - Advanced features (grounding, function calling, etc.)"
echo ""
echo "For more information:"
echo "  - Vertex AI: https://cloud.google.com/vertex-ai/docs/generative-ai/start/quickstarts/quickstart-multimodal"
echo "  - Google AI Studio: https://makersuite.google.com/"
echo "  - Gemini API: https://ai.google.dev/"
echo ""
