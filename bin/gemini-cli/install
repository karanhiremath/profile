#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${APP_BIN}/sh/shell_fns" --source-only
. "${APP_BIN}/sh/brew_helper.sh"

app_name="gemini-cli"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Handle command line arguments
case "${1:-}" in
    -h|--help)
        cat "${SCRIPT_DIR}/README.md"
        exit 0
        ;;
    --setup-vertex-ai)
        setup_vertex_ai_env "gemini"
        exit 0
        ;;
esac

if command -v gemini >/dev/null 2>&1; then
    echo "Gemini CLI already installed!"
    echo ""
    echo "For setup instructions, run: ${BASH_SOURCE[0]} --help"
    echo "For interactive Vertex AI setup, run: ${BASH_SOURCE[0]} --setup-vertex-ai"
    exit 0
else
    install_messages "start" "$app_name"

    case "${MACHINE}" in
        Darwin|Linux)
            echo "Installing Gemini CLI..."
            # Check if pip3 is available
            if ! command -v pip3 >/dev/null 2>&1; then
                echo "pip3 not found. Installing Python3 and pip..."
                case "${MACHINE}" in
                    Darwin)
                        ensure_brew_in_path || {
                            echo "ERROR: Homebrew not found. Please install Homebrew first."
                            exit 1
                        }
                        brew install python3
                        ;;
                    Linux)
                        if command -v apt-get >/dev/null 2>&1; then
                            sudo apt-get update && sudo apt-get install -y python3-pip
                        elif command -v dnf >/dev/null 2>&1; then
                            sudo dnf install -y python3-pip
                        elif command -v yum >/dev/null 2>&1; then
                            sudo yum install -y python3-pip
                        else
                            echo "ERROR: Could not install pip3. Please install Python3 and pip3 manually."
                            exit 1
                        fi
                        ;;
                esac
            fi
            
            # Install gemini-cli package
            pip3 install --user gemini-cli
            ;;
        *)
            echo "Unsupported platform: ${MACHINE}"
            exit 1
            ;;
    esac

    install_messages "end" "$app_name"
fi

echo ""
echo "=========================================="
echo "Gemini CLI installed successfully!"
echo "=========================================="
echo ""
echo "Next Steps:"
echo ""
echo "1. For detailed setup instructions:"
echo "   ${SCRIPT_DIR}/install --help"
echo ""
echo "2. Quick start with Google AI Studio API:"
echo "   - Get API key: https://makersuite.google.com/app/apikey"
echo "   - Set: export GEMINI_API_KEY='your-api-key'"
echo "   - Usage: gemini 'your prompt here'"
echo ""
echo "3. For enterprise/production with Vertex AI:"
echo "   ${SCRIPT_DIR}/install --setup-vertex-ai"
echo ""
