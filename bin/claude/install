#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${APP_BIN}/sh/shell_fns" --source-only
. "${APP_BIN}/sh/brew_helper.sh"

app_name="claude-code"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

# Check if already installed
if command -v claude-code >/dev/null 2>&1; then
    echo "Claude Code already installed!"
    exit 0
fi

install_messages "start" "$app_name"

# Function to check Node.js version
check_node_version() {
    if command -v node >/dev/null 2>&1; then
        local node_version
        node_version=$(node --version | sed 's/v//' | cut -d. -f1)
        if [ "$node_version" -ge 18 ]; then
            return 0
        fi
    fi
    return 1
}

# Ensure Node.js and npm are installed and up to date
if ! check_node_version; then
    echo "Node.js 18+ is required. Installing/updating Node.js..."
    case "${MACHINE}" in
        Darwin)
            ensure_brew_in_path || {
                echo "ERROR: Homebrew not found. Please install Homebrew first."
                exit 1
            }
            # Install or upgrade Node.js via Homebrew
            if brew list node &>/dev/null; then
                echo "Upgrading Node.js..."
                brew upgrade node || brew install node
            else
                echo "Installing Node.js..."
                brew install node
            fi
            ;;
        Linux)
            # Install Node.js via package manager
            if command -v apt-get >/dev/null 2>&1; then
                echo "Installing Node.js on Debian/Ubuntu..."
                # Use NodeSource repository for latest LTS
                curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
                sudo apt-get install -y nodejs
            elif command -v dnf >/dev/null 2>&1; then
                echo "Installing Node.js on Fedora/RHEL..."
                curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
                sudo dnf install -y nodejs
            elif command -v yum >/dev/null 2>&1; then
                echo "Installing Node.js on CentOS/RHEL..."
                curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
                sudo yum install -y nodejs
            else
                echo "ERROR: Could not install Node.js. Please install Node.js 18+ manually."
                exit 1
            fi
            ;;
        *)
            echo "Unsupported platform: ${MACHINE}"
            exit 1
            ;;
    esac
fi

# Verify Node.js and npm are available
if ! command -v node >/dev/null 2>&1 || ! command -v npm >/dev/null 2>&1; then
    echo "ERROR: Node.js or npm not found after installation."
    exit 1
fi

echo "Node.js version: $(node --version)"
echo "npm version: $(npm --version)"

# Install Claude Code via npm
echo "Installing Claude Code..."
case "${MACHINE}" in
    Darwin|Linux)
        npm install -g @anthropic-ai/claude-code
        ;;
    *)
        echo "Unsupported platform: ${MACHINE}"
        exit 1
        ;;
esac

install_messages "end" "$app_name"

echo ""
echo "Claude Code installed successfully!"
echo ""
echo "=========================================="
echo "Setup Options:"
echo "=========================================="
echo ""
echo "OPTION 1: Direct Anthropic API (Recommended for development)"
echo "-----------------------------------------------------------"
echo "Usage:"
echo "  claude-code --help           - Show help"
echo "  claude-code <prompt>         - Run Claude Code with a prompt"
echo ""
echo "Note: You'll need to set up your Anthropic API key."
echo "Visit: https://console.anthropic.com/ to get your API key"
echo "Then set: export ANTHROPIC_API_KEY='your-api-key'"
echo ""
echo "OPTION 2: Google Cloud Vertex AI (Recommended for production/enterprise)"
echo "-------------------------------------------------------------------------"
echo "Vertex AI provides access to Claude models via Google Cloud Platform."
echo ""
echo "Prerequisites:"
echo "  1. Google Cloud account with billing enabled"
echo "  2. A GCP project created"
echo "  3. Google Cloud SDK (gcloud) installed"
echo ""
echo "Setup Steps:"
echo ""
echo "  1. Install Google Cloud SDK if not already installed:"
echo "     - macOS: brew install google-cloud-sdk"
echo "     - Linux: curl https://sdk.cloud.google.com | bash"
echo ""
echo "  2. Initialize and authenticate:"
echo "     gcloud init"
echo "     gcloud auth login"
echo "     gcloud auth application-default login"
echo ""
echo "  3. Set your project:"
echo "     gcloud config set project YOUR_PROJECT_ID"
echo ""
echo "  4. Enable required APIs:"
echo "     gcloud services enable aiplatform.googleapis.com"
echo ""
echo "  5. Grant necessary permissions (if needed):"
echo "     gcloud projects add-iam-policy-binding YOUR_PROJECT_ID \\"
echo "       --member='user:YOUR_EMAIL' \\"
echo "       --role='roles/aiplatform.user'"
echo ""
echo "  6. Set environment variables:"
echo "     export GOOGLE_CLOUD_PROJECT='YOUR_PROJECT_ID'"
echo "     export GOOGLE_CLOUD_REGION='us-central1'  # or your preferred region"
echo ""
echo "  7. Configure Claude Code to use Vertex AI:"
echo "     Add to your shell profile (~/.bashrc, ~/.zshrc, etc.):"
echo "     export ANTHROPIC_VERTEX_AI=true"
echo "     export ANTHROPIC_PROJECT_ID='YOUR_PROJECT_ID'"
echo "     export ANTHROPIC_REGION='us-central1'"
echo ""
echo "Available Claude Models on Vertex AI:"
echo "  - claude-3-opus@20240229"
echo "  - claude-3-sonnet@20240229"
echo "  - claude-3-haiku@20240307"
echo "  - claude-3-5-sonnet@20240620"
echo ""
echo "Vertex AI Benefits:"
echo "  - Enterprise-grade security and compliance"
echo "  - Integrated with Google Cloud services"
echo "  - Unified billing and management"
echo "  - Data residency and privacy controls"
echo "  - No separate Anthropic API key needed"
echo ""
echo "For more information:"
echo "  - Vertex AI: https://cloud.google.com/vertex-ai/docs/generative-ai/model-garden/claude"
echo "  - Anthropic: https://console.anthropic.com/"
echo ""
