#!/bin/bash

set -euo pipefail

shopt -s failglob

. "${APP_BIN}/sh/shell_fns" --source-only
. "${APP_BIN}/sh/brew_helper.sh"

app_name="claude-code"

MACHINE="$(uname -s)"
ARCH="$(uname -m)"

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Handle command line arguments
case "${1:-}" in
    -h|--help)
        cat "${SCRIPT_DIR}/README.md"
        exit 0
        ;;
    --setup-vertex-ai)
        setup_vertex_ai_env "claude"
        exit 0
        ;;
esac

# Check if already installed
if command -v claude-code >/dev/null 2>&1; then
    echo "Claude Code already installed!"
    echo ""
    echo "For setup instructions, run: ${BASH_SOURCE[0]} --help"
    echo "For interactive Vertex AI setup, run: ${BASH_SOURCE[0]} --setup-vertex-ai"
    exit 0
fi

install_messages "start" "$app_name"

# Function to check Node.js version
check_node_version() {
    if command -v node >/dev/null 2>&1; then
        local node_version
        node_version=$(node --version | sed 's/v//' | cut -d. -f1)
        if [ "$node_version" -ge 18 ]; then
            return 0
        fi
    fi
    return 1
}

# Ensure Node.js and npm are installed and up to date
if ! check_node_version; then
    echo "Node.js 18+ is required. Installing/updating Node.js..."
    case "${MACHINE}" in
        Darwin)
            ensure_brew_in_path || {
                echo "ERROR: Homebrew not found. Please install Homebrew first."
                exit 1
            }
            # Install or upgrade Node.js via Homebrew
            if brew list node &>/dev/null; then
                echo "Upgrading Node.js..."
                brew upgrade node || brew install node
            else
                echo "Installing Node.js..."
                brew install node
            fi
            ;;
        Linux)
            # Install Node.js via package manager
            if command -v apt-get >/dev/null 2>&1; then
                echo "Installing Node.js on Debian/Ubuntu..."
                # Use NodeSource repository for latest LTS
                curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
                sudo apt-get install -y nodejs
            elif command -v dnf >/dev/null 2>&1; then
                echo "Installing Node.js on Fedora/RHEL..."
                curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
                sudo dnf install -y nodejs
            elif command -v yum >/dev/null 2>&1; then
                echo "Installing Node.js on CentOS/RHEL..."
                curl -fsSL https://rpm.nodesource.com/setup_lts.x | sudo bash -
                sudo yum install -y nodejs
            else
                echo "ERROR: Could not install Node.js. Please install Node.js 18+ manually."
                exit 1
            fi
            ;;
        *)
            echo "Unsupported platform: ${MACHINE}"
            exit 1
            ;;
    esac
fi

# Verify Node.js and npm are available
if ! command -v node >/dev/null 2>&1 || ! command -v npm >/dev/null 2>&1; then
    echo "ERROR: Node.js or npm not found after installation."
    exit 1
fi

echo "Node.js version: $(node --version)"
echo "npm version: $(npm --version)"

# Install Claude Code via npm
echo "Installing Claude Code..."
case "${MACHINE}" in
    Darwin|Linux)
        npm install -g @anthropic-ai/claude-code
        ;;
    *)
        echo "Unsupported platform: ${MACHINE}"
        exit 1
        ;;
esac

install_messages "end" "$app_name"

echo ""
echo "=========================================="
echo "Claude Code installed successfully!"
echo "=========================================="
echo ""
echo "Next Steps:"
echo ""
echo "1. For detailed setup instructions:"
echo "   ${SCRIPT_DIR}/install --help"
echo ""
echo "2. Quick start with Anthropic API:"
echo "   - Get API key: https://console.anthropic.com/"
echo "   - Set: export ANTHROPIC_API_KEY='your-api-key'"
echo ""
echo "3. For enterprise/production with Vertex AI:"
echo "   ${SCRIPT_DIR}/install --setup-vertex-ai"
echo ""
